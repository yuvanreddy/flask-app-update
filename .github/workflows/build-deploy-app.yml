name: Build, Push & Deploy Flask App

on:
  push:
    branches: [ main, master, develop, photo-upload-app ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'k8s/**'
      - '.github/workflows/**'
      - '**.py'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: flask-eks
  NAMESPACE: default
  IMAGE_NAME: flask-devops-demo
  PYTHON_VERSION: '3.11'

  # Workload names
  DEPLOYMENT: flask-app
  CONTAINER: flask
  SERVICE: flask-svc

  # Cloudsmith (registry)
  REG_SERVER: docker.cloudsmith.io
  REG_SECRET: cloudsmith-regcred
  APP_SA: flask-app-sa
  CLOUDSMITH_REPO: flask-sample-app/photouploadd-app

  # Ingress/ALB settings
  INGRESS_NAME: flask-alb
  INGRESS_CLASS: alb
  INGRESS_GROUP: flask-demo
  HEALTHCHECK_PATH: /health
  BACKEND_PORT: 5000

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    outputs:
      security-passed: ${{ steps.security-check.outputs.passed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit[toml] safety

      - name: Run Bandit (SAST - Python Security)
        run: |
          echo "Running Bandit security scan..."
          bandit -r . -ll -f json -o bandit-report.json || true
          bandit -r . -ll -f screen
        continue-on-error: true

      - name: Run Safety (Dependency Vulnerability Scan)
        run: |
          echo "Scanning dependencies for known vulnerabilities..."
          safety scan --json > safety-report.json || true
          safety scan
        continue-on-error: true

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

      - name: Check Security Scan Results
        id: security-check
        run: |
          if [ -f bandit-report.json ]; then
            HIGH_ISSUES=$(cat bandit-report.json | jq '.metrics.total.ISSUE_HIGH // 0')
            if [ "$HIGH_ISSUES" -gt 0 ]; then
              echo "âš ï¸  High severity security issues found: $HIGH_ISSUES"
              echo "passed=false" >> $GITHUB_OUTPUT
            fi
          fi
          echo "âœ… Security scan passed"
          echo "passed=true" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: security-scan
    if: needs.security-scan.outputs.security-passed == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      image-full: ${{ steps.image-info.outputs.full-image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Cloudsmith
        uses: docker/login-action@v3
        with:
          registry: docker.cloudsmith.io
          username: ${{ secrets.CLOUDSMITH_USERNAME }}
          password: ${{ secrets.CLOUDSMITH_API_KEY }}

      - name: Generate image tags
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_BASE="docker.cloudsmith.io/${{ env.CLOUDSMITH_REPO }}/${{ env.IMAGE_NAME }}"
          
          echo "IMAGE_TAG=latest-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "IMAGE_LATEST=${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
          echo "IMAGE_SHA=${IMAGE_BASE}:latest-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ steps.meta.outputs.IMAGE_LATEST }} \
            -t ${{ steps.meta.outputs.IMAGE_SHA }} \
            .

      - name: Run Trivy (Scan Local Image)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: ${{ steps.meta.outputs.IMAGE_LATEST }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Push to Cloudsmith
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ“¦ Pushing images to Cloudsmith..."
          docker push ${{ steps.meta.outputs.IMAGE_LATEST }}
          docker push ${{ steps.meta.outputs.IMAGE_SHA }}
          echo "âœ… Images pushed successfully!"

      - name: Set image info for deployment
        id: image-info
        run: |
          echo "full-image=${{ steps.meta.outputs.IMAGE_SHA }}" >> $GITHUB_OUTPUT
          echo "image-tag=${{ steps.meta.outputs.IMAGE_TAG }}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  Image: ${{ steps.meta.outputs.IMAGE_SHA }}"

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-push]
    if: |
      (needs.security-scan.outputs.security-passed == 'true' || github.event_name == 'workflow_dispatch') &&
      needs.build-and-push.result == 'success' &&
      github.event_name != 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Show expected sub
        run: |
          echo "GITHUB_REPOSITORY=${{ github.repository }}"
          echo "GITHUB_REF=${{ github.ref }}"
          echo "Expected sub: repo:${{ github.repository }}:ref:${{ github.ref }}"

      - name: Caller identity (should be assumed-role)
        run: aws sts get-caller-identity

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"
          kubectl version --client

      - name: Ensure namespace exists
        run: |
          kubectl get ns "${NAMESPACE}" >/dev/null 2>&1 || kubectl create ns "${NAMESPACE}"

      - name: Create/Update Cloudsmith imagePullSecret
        run: |
          kubectl create secret docker-registry "${REG_SECRET}" \
            --namespace "${NAMESPACE}" \
            --docker-server="${REG_SERVER}" \
            --docker-username="${{ secrets.CLOUDSMITH_USERNAME }}" \
            --docker-password="${{ secrets.CLOUDSMITH_API_KEY }}" \
            --docker-email="devnull@example.com" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Ensure workload ServiceAccount uses imagePullSecret
        run: |
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: ${APP_SA}
            namespace: ${NAMESPACE}
          imagePullSecrets:
          - name: ${REG_SECRET}
          EOF

      - name: Ensure Service exists
        run: |
          if ! kubectl -n "${NAMESPACE}" get svc "${SERVICE}" >/dev/null 2>&1; then
            kubectl apply -f k8s/service.yml
          fi

      - name: Deploy application
        run: |
          FULL_IMAGE="${{ needs.build-and-push.outputs.image-full }}"
          echo "ðŸš€ Deploying image: ${FULL_IMAGE}"

          # Apply or create deployment
          if ! kubectl -n "${NAMESPACE}" get deploy "${DEPLOYMENT}" >/dev/null 2>&1; then
            echo "Creating new deployment..."
            kubectl apply -f k8s/deployment.yaml
          fi

          # Update image
          kubectl set image deployment/${DEPLOYMENT} \
            ${CONTAINER}=${FULL_IMAGE} \
            -n ${NAMESPACE}

          # Add annotation to trigger rollout
          kubectl patch deployment ${DEPLOYMENT} -n ${NAMESPACE} -p \
            "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"deployedAt\":\"$(date +'%s')\"}}}}}"

          # Wait for rollout
          echo "â³ Waiting for rollout to complete..."
          kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=300s
          
          echo "âœ… Deployment successful!"

      - name: Ensure Ingress exists
        run: |
          if ! kubectl -n "${NAMESPACE}" get ingress "${INGRESS_NAME}" >/dev/null 2>&1; then
            kubectl apply -f k8s/ingress.yml
          fi

      - name: Fetch ALB address and Display URLs
        id: alb
        run: |
          echo "â³ Waiting for ALB to be ready..."
          for i in $(seq 1 60); do
            HOST=$(kubectl -n "${NAMESPACE}" get ingress "${INGRESS_NAME}" \
              -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || true)
            
            if [ -n "$HOST" ]; then
              echo "âœ… ALB Ready!"
              echo "host=$HOST" >> $GITHUB_OUTPUT

              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸŽ‰ APPLICATION DEPLOYED SUCCESSFULLY!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ“± Main App:      http://$HOST/"
              echo "ðŸ¥ Health Check:  http://$HOST${HEALTHCHECK_PATH}"
              echo "ðŸ“¸ Upload Page:   http://$HOST/upload"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""

              # GitHub Step Summary
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸŒ Application URLs:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ“± **Main App:** http://$HOST/" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ¥ **Health Check:** http://$HOST${HEALTHCHECK_PATH}" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ“¸ **Upload Page:** http://$HOST/upload" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“¦ Docker Image:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${{ needs.build-and-push.outputs.image-full }}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            echo "â³ Waiting for ALB... (attempt $i/60)"
            sleep 10
          done

          if [ -z "$HOST" ]; then
            echo "âš ï¸ ALB not ready after 10 minutes. Check AWS Console."
            echo "host=pending" >> $GITHUB_OUTPUT
          fi

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-push, deploy]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "| ðŸ”’ Security Scan | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”’ Security Scan | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "| ðŸ³ Docker Build & Push | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ³ Docker Build & Push | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "| â˜¸ï¸  Kubernetes Deploy | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "| â˜¸ï¸  Kubernetes Deploy | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â˜¸ï¸  Kubernetes Deploy | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** flask-sample-app/photouploadd-app" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY